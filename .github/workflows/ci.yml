name: CI

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        zig-version: ['0.15.2']

    steps:
    - uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: ${{ matrix.zig-version }}

    - name: Check formatting
      run: zig fmt --check src/ build.zig

    - name: Build
      run: zig build

    - name: Run tests
      run: zig build test

    - name: Run examples
      run: |
        zig build example1
        zig build example2
        zig build example3
        zig build example4
        zig build example5
        zig build example6
        zig build example7
        zig build example8

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: '0.15.2'

    - name: Build and test
      run: |
        zig fmt --check src/ build.zig
        zig build
        zig build test
        zig build benchmark

    - name: Create release archive
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        ARCHIVE_NAME=zig-klc-${VERSION}.tar.gz
        git archive --format=tar.gz --prefix=zig-klc-${VERSION}/ -o ${ARCHIVE_NAME} HEAD

    - name: Create GitHub release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## Changes

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/CHANGELOG.md) for details.

          ## Installation

          ```bash
          zig fetch --save https://github.com/${{ github.repository }}/archive/${{ github.sha }}.tar.gz
          ```

          Or use the package directly in your `build.zig.zon`:

          ```zig
          .dependencies = .{
              .klc = .{
                  .url = "https://github.com/${{ github.repository }}/archive/${{ github.sha }}.tar.gz",
                  .hash = "TODO: Update with actual hash",
              },
          },
          ```
        draft: false
        prerelease: false